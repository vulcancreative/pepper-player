!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("pepper",[],t):"object"==typeof exports?exports.pepper=t():e.pepper=t()}("undefined"!=typeof self?self:this,function(){return function(e){function t(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return e[s].call(n.exports,n,n.exports,t),n.l=!0,n.exports}var i={};return t.m=e,t.c=i,t.d=function(e,i,s){t.o(e,i)||Object.defineProperty(e,i,{configurable:!1,enumerable:!0,get:s})},t.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},t.n=function(e){var i=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(i,"a",i),i},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=12)}([function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i="undefined",s=e=>null===e||typeof e===i;t.default={def:e=>null!==e&&typeof e!==i,ndef:s,a:(e,t)=>t.getAttribute(e),q:(e,t)=>((e,t)=>(s(t)&&(t=document),t=[].slice.call(t.querySelectorAll(e))))(e,t)}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.sizeDict=function(e){return Object.keys(e).length},t.mergeDicts=function(e,t){let i={};for(let s of Object.keys(t))i[s]=null!==e[s]&&void 0!==e[s]?e[s]:t[s];return i},t.randInt=function(e,t){return parseInt(Math.floor(Math.random()*(t-e+1)+e))},t.isInt=function(e){if(isNaN(e))return!1;var t=parseFloat(e);return(0|t)===t}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kProtocol={hls:"HLS",dash:"DASH"},t.kStreamType={audio:"audio",video:"video",muxed:"muxed",image:"image"},t.kSegmentType={init:"initialization",segment:"segment"},t.kTransitions={countdown:"countdown",immedaite:"immediate"},t.kBackingType={splitX:"splitX",splitY:"splitY",uniform:"uniform"}},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toInt=(e=>{const t=e%1,i=parseInt(e);return isNaN(t)||isNaN(i)?null:i}),t.msToStamp=(e=>{let t="",i=1e3*Math.floor(e>-1?e:0)/1e3,s=0,n=0,r=0;for(;i>=36e5;)i-=36e5,s++;for(;i>=6e4;)i-=6e4,n++;return r=i/1e3,s>0&&(t+=`${s}:`),t+(s>0?`${n.toFixed(0)}`.padStart(2,"0"):`${n}`)+":"+`${r.toFixed(0)}`.padStart(2,"0")}),t.toDuration=(e=>{const t=[0,0,31536e6,254016e4,6048e5,864e5,36e5,6e4,1e3];return e.match(/(-)?P(?:([.,\d]+)Y)?(?:([.,\d]+)M)?(?:([.,\d]+)W)?(?:([.,\d]+)D)?T(?:([.,\d]+)H)?(?:([.,\d]+)M)?(?:([.,\d]+)S)?/).reduce((e,i,s)=>s<2?0:null===i||void 0===i?e+0:e+i*t[s])}),t.arrayBufferToBase64=(e=>{for(var t="",i=new Uint8Array(e),s=i.byteLength,n=0;n<s;n++)t+=String.fromCharCode(i[n]);return btoa(t)})},function(e,t){"use strict";var i,s,n;Object.defineProperty(t,"__esModule",{value:!0}),t.os=(i=navigator,s=(i.userAgent+" "+i.oscpu).toLowerCase(),n={is:function(e,t){switch(t=/bot|spider|crawl|seeker/,e=e.toLowerCase()){case"safari":return/^((?!chrome).)*safari/.test(s);default:return~s.search(e)||t.test(s)}}}),t.os=n},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.repToM3U8=t.mpdToM3U8=t.hlsPreferred=t.hlsSupported=t.hlsMimeType=void 0;var s=i(4),n=i(2);const r="application/vnd.apple.mpegurl",a=()=>{let e=document.createElement("video");return e.canPlayType&&!!e.canPlayType("application/vnd.apple.mpegurl")},o=(e,t)=>{const i=t.segmentLength(),s=Math.ceil(e.duration/i),n=Array(s).fill().map((e,s)=>`#EXTINF:${parseFloat(i/1e3).toFixed(5)},\n${t.mediaURL(s+1)}`),a="#EXTM3U\n"+`#EXT-X-TARGETDURATION:${parseInt(Math.ceil(i/1e3))}\n`+"#EXT-X-VERSION:7\n"+`#EXT-X-PLAYLIST-TYPE:${"static"===e.type?"VOD":"EVENT"}\n`+"#EXT-X-INDEPENDENT-SEGMENTS\n"+`#EXT-X-MAP:URI="${t.initURL()}"\n`+n.join("\n")+"\n"+`${"static"===e.type?"#EXT-X-ENDLIST":""}`,o=new Blob([a],{type:r});return URL.createObjectURL(o)};t.hlsMimeType=r,t.hlsSupported=a,t.hlsPreferred=(()=>!s.os.is("chrome")&&(a(),!1)),t.mpdToM3U8=(e=>{const t=[].concat(...e.mpd.adps.map(e=>e.reps)),i=t.filter(e=>e.type===n.kStreamType.audio),s=t.filter(e=>e.type===n.kStreamType.video),r=i.map(t=>{const i=o(e.mpd,t);return"#EXT-X-MEDIA:TYPE=AUDIO,"+`GROUP-ID="${t.id}",`+`NAME="${t.id}",`+'LANGUAGE="en-US",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2",'+`URI="${i}"`}),a=s.map(t=>{const s=o(e.mpd,t);return"#EXT-X-STREAM-INF:"+`BANDWIDTH=${t.bandwidth},`+`CODECS="${t.codecs},${i[0].codecs}",`+`RESOLUTION=${t.width}x${t.height},`+`AUDIO="${i[0].id}"\n`+`${s}`});return"#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-INDEPENDENT-SEGMENTS\n"+r.join("\n")+"\n"+a.join("\n")}),t.repToM3U8=o},function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.kbps=function(e,t){const i=((8*e/t).toFixed(2)/1024).toFixed(2);return parseFloat(i)},t.speedFactor=function(e,t,i){const s=i/1e3,n=(parseFloat(8*t/(1024*e))/parseFloat(s)).toFixed(2);return parseFloat(n)}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Stream=void 0;var s=i(1),n=i(3),r=i(2);t.Stream=class{constructor(e={}){this.config=(0,s.mergeDicts)(e,{mediaSource:null,mpd:null,adp:null,rep:null,sources:null}),this.mediaSource=this.config.mediaSource,this.mpd=this.config.mpd,this.adp=this.config.adp,this.rep=this.config.rep,this.sources=this.config.sources}setup(){return new Promise(e=>{this.init_().then(t=>{this.cache=t,e()})})}init_(e=[]){return new Promise(t=>{if(this.type=this.rep.type,this.codecs=`${this.rep.mimeType}; codecs="${this.rep.codecs}"`,MediaSource.isTypeSupported(this.codecs)){this.buffer=this.mediaSource.addSourceBuffer(this.codecs),this.buffer.mode="sequence","dynamic"===this.mpd.type&&(this.buffer.timestampOffset=.1);for(let i=0;i!=this.sources.length;i++){const s=this.sources[i],n=s.initURL();this.fetchSegment_(n).then(n=>{if(e.push({type:r.kSegmentType.init,rep:s.id,point:0,data:n,size:n.byteLength}),i===this.sources.length-1)for(let i=0;i!=e.length;i++){const s=e[i];0===s.point&&s.rep===this.rep.id&&this.appendBuffer(this.buffer,s).then(i=>{this.buffer=i,t(e)})}})}}else t(e)})}fetchSegment_(e=""){return new Promise((t,i)=>{const s=this.rep.id,n=this.mpd.type,r=new XMLHttpRequest;r.onload=function(){r.status>=400&&"dynamic"===n?t(null):r.status>=200&&r.status<400?t(r.response):i(`Unable to fetch segment at "${e}" for rep "${s}"`)},r.open("GET",e),r.responseType="arraybuffer",r.send()})}appendBuffer(e,t){return new Promise((i,s)=>{null!==e&&void 0!==e||s("Buffer invalid!"),null!==t&&void 0!==t||s("Segment invalid!");try{e.appendBuffer(new Uint8Array(t.data))}catch(e){}e.onupdateend=(()=>i(e))})}bufferedLength(){const e=this.cache.length;return e<2?0:Math.round((e-1)*this.segmentLength())}fillBuffer(e){return new Promise(t=>{const i=this.rep,s=i.mediaURL(e);this.fetchSegment_(s).catch(()=>{}).then(s=>{if(null!==s&&void 0!==s)return this.type===r.kStreamType.image?(this.cache.push({point:e,mime:this.rep.mimeType,data:(0,n.arrayBufferToBase64)(s),info:i.tileInfo}),void t(s.byteLength)):(this.cache.push({type:r.kSegmentType.segment,point:e,data:s,size:s.byteLength}),void this.appendBuffer(this.buffer,this.cache[this.cache.length-1]).then(e=>{this.buffer=e,t(s.byteLength)}));t(null)})})}inCache(e=[]){let t=e=>{let t,i,s=0,n=this.cache.length-1;for(;s<=n;)if((i=this.cache[t=(s+n)/2|0]).point<e)s=t+1;else{if(!(i.point>e))return t;n=t-1}return-1},i=[];if(e.constructor===Array)for(let s=0;s!=e.length;s++){const n=e[s];t(n)>-1&&i.push(n)}else{if(!(0,s.isInt)(e))throw`Invalid argument value : "${e}"`;{const s=e;t(s)>-1&&i.push(s)}}return i}makePoints(e,t,i,s){var n=function(e){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e){var t=[],i=!0,s=!1,n=void 0;try{for(var r,a=e[Symbol.iterator]();!(i=(r=a.next()).done)&&(t.push(r.value),2!==t.length);i=!0);}catch(e){s=!0,n=e}finally{try{!i&&a.return&&a.return()}finally{if(s)throw n}}return t}(e);throw new TypeError("Invalid attempt to destructure non-iterable instance")}(s.makePoints(this.mpd,e,t,i));const r=n[0];return this.lastPoint=n[1],r}popCache(e=1){return new Promise((t,i)=>{let s=0;this.cache.length<e+1&&t();for(let e=1;e<this.cache.length;e++)if(this.cache[e].type!==r.kSegmentType.init&&this.cache[e-1].type===r.kSegmentType.init&&this.cache[e].type===r.kSegmentType.segment){s=e;break}0===s&&i(),s+1+e>this.cache.length&&i(),this.cache.splice(s,e),t()})}segmentLength(){const e=this.rep;if(null===e&&void 0===e)throw`Unable to determine segment length of rep "${e.id}"`;return e.segmentLength()}switchToRep(e){return new Promise(t=>{for(let i=0;i!=this.cache.length;i++){const s=this.cache[i];0===s.point&&s.rep===e&&this.appendBuffer(this.buffer,s).then(i=>{this.buffer=i,this.id=e;for(let t=0;t!=this.sources.length;t++){const i=this.sources[t];if(i.id===e){this.rep=i;break}}t()})}})}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,n=(s=i(0))&&s.__esModule?s:{default:s},r=i(3),a=i(2);t.default=class{constructor(e,t,i,s){let o,u,l,h,d,c,p,f,m,g,y,v,T,b,S,w,P;o=n.default.a("id",t),b=n.default.a("mimeType",e),n.default.ndef(b)&&(b=n.default.a("mimeType",t)),u=n.default.a("codecs",t);const _=n.default.a("width",t),M=n.default.a("height",t);l=(0,r.toInt)(_)||0,h=(0,r.toInt)(M)||0;const I=n.default.a("bandwidth",t);d=(0,r.toInt)(I),c=s||"";const L=i.split("/"),D=L.length;if(c=D>1?L.slice(0,D-1).join("/"):"/",c+="/"===c.charAt(c.length-1)?"":"/",m=n.default.q("SegmentTimeline",e)[0],n.default.def(m)&&(y=[...m.children]),(g=n.default.q("SegmentTemplate",e)[0])||(g=n.default.q("SegmentTemplate",t)[0]),g){f=n.default.a("media",g),p=n.default.a("initialization",g),n.default.def(p)&&(p=p.replace("$RepresentationID$",o));const e=n.default.a("startNumber",g);v=(0,r.toInt)(e);const t=n.default.a("timescale",g);T=(0,r.toInt)(t);const i=n.default.a("duration",g);S=(0,r.toInt)(i)}if(b&&b.includes("video")&&l&&h?w=a.kStreamType.video:b&&b.includes("audio")&&d?w=a.kStreamType.audio:b&&b.includes("image")&&(w=a.kStreamType.image),w===a.kStreamType.image){let e="1x1";const i=n.default.a("duration",g),s=n.default.q("EssentialProperty",t)[0];s&&(e=n.default.a("value",s)),P={duration:1e3*parseInt(i),count:parseInt(e.split("x")[0]),width:l,height:h}}this.id=o,this.mimeType=b,this.codecs=u,this.width=l,this.height=h,this.bandwidth=d,this.baseURL=c,this.timeline=y,this.mediaTemplate=f,this.initialization=p,this.startNumber=v,this.timescale=T,this.segmentDuration=S,this.tileInfo=P,this.type=w}initURL(){const e=this.initialization,t=this.baseURL;return(t?`${t}${e}`:e).replace(/\$RepresentationID\$/g,`${this.id}`)}makePoints(e,t,i,s){return n.default.def(this.timeline)?this.makeTimelinePoints(this.lastPoint):[this.makeTemplatePoints(e,t,i,s),null]}makeTimelinePoints(e){if(this.timeline.length<1)return null;let t=[];const i=this.timeline[0],s=parseInt(i.getAttribute("t")),n=parseInt(i.getAttribute("d"));return[t=[e?e+n:s],t[t.length-1]]}makeTemplatePoints(e,t,i,s){const n=this.segmentLength();if("static"===this.mpd.type){if(this.type===a.kStreamType.image&&null!==this.tileInfo){const t=Math.ceil(e.duration/this.tileInfo.duration);return new Array(t).fill(0).map((e,t)=>t+1)}const s=parseInt(Math.ceil(parseFloat((i<t?t+1e3:i)-t)/parseFloat(n))),r=parseInt(Math.ceil(parseFloat(t)/parseFloat(n)));return new Array(s).fill(r).map((e,t)=>e+(t+1))}if("dynamic"===e.type){const t=Math.abs(s-e.startTime);return[Math.ceil(t/n-10)]}throw`Unable to decipher source type ("${e.type}")`}mediaURL(e){const t=/\$Time\$/g,i=/\$Number\$/g,s=`${e}`;let n=this.mediaTemplate.replace(/\$RepresentationID\$/g,`${this.id}`);if(t.test(n)&&this.timeline.length>0)n=n.replace(t,s);else if(/(\$Number%(\d+)d\$)/g.test(n)){const e=/(\$Number%(\d+)d\$)/g.exec(n),t=parseInt(e[e.length-1])+1,r=s.padStart(t-1,"0");n=(n=n.replace(e[0],r)).replace(i,s)}else n=n.replace(i,s);const r=this.baseURL;return r?`${r}${n}`:n}segmentLength(){if(this.timeline&&this.timeline.length>0){const e=[];for(let t=0;t<this.timeline.length;t++){const i=this.timescale,s=parseInt(this.timeline[t].getAttribute("d"));e.push(s/i)}if(e.length>0)return e.reduce((e,t)=>e+t)/e.length*1e3}const e=parseFloat(this.timescale),t=parseFloat(this.segmentDuration);if(null===e&&void 0===e||isNaN(e))return 1e3*t;const i=Math.floor(t/e);return 1e3*parseInt(i)}weight(){return this.width+this.height+this.bandwidth}}},function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0});var n=s(i(0)),r=s(i(8)),a=i(3);t.default=class{constructor(e,t,i,s){const r=n.default.a("maxWidth",e),o=n.default.a("maxHeight",e);this.adp=e,this.index=t,this.maxWidth=(0,a.toInt)(r),this.maxHeight=(0,a.toInt)(o),this.reps=this.reps_(e,i,s)}reps_(e,t,i){const s=n.default.q("Representation",e);if(s&&s.length>0){let a=[];for(let n=0;n!=s.length;n++)a.push(new r.default(e,s[n],t,i));const o=a.map(e=>n.default.ndef(e.bandwidth)?null:e.bandwidth);if(o.includes(null)){const e=o.findIndex(e=>null!==e),t=e>-1?o[e]:0;a=a.map(e=>(e.bandwidth=t,e))}return a.sort((e,t)=>e.weight()<t.weight()?-1:e.weight()>t.weight()?1:0),a}throw`No representations present in adaptation[${this.index}]`}bestRep(){return this.reps.length-1}strongerRep(e){let t;const i=this.reps;for(let s=0;s!=i.length;s++)if(i[s].id===e){t=i[s];break}let s=t,n=t.weight();for(let e=0;e!=i.length;e++)if(i[e].weight()>n){s=i[e];break}return s}weakerRep(e){let t;const i=this.reps.slice().reverse();for(let s=0;s!=i.length;s++)if(i[s].id===e){t=i[s];break}let s=t,n=t.weight();for(let e=0;e!=i.length;e++)if(i[e].weight()<n){s=i[e];break}return s}worstRep(){return 0}}},function(e,t,i){"use strict";function s(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(t,"__esModule",{value:!0}),t.MPD=void 0;var n=s(i(0)),r=s(i(9)),a=i(1),o=i(3);t.MPD=class{constructor(e={}){this.config=(0,a.mergeDicts)(e,{url:"",base:"",data:null})}async setup(){const e=await this.fetch_(this.config.url,this.config.data),t=this.parse_(e);if(t)throw t;return this}fetch_(e="",t){return new Promise(i=>{n.default.def(t)&&i(t,"data");const s=new XMLHttpRequest;s.onload=function(){const e=s.getResponseHeader("Date");new Date(e),Date.now(),i(s.response,"xml")},s.open("GET",e),s.send()})}parse_(e=""){const t=this.config.base;return this.mpd=this.xml_(e),this.baseURL=this.baseURL_(this.mpd,t),this.adps=this.adps_(this.mpd,this.config.url,this.baseURL),this.duration=this.duration_(this.mpd),this.dvr=this.dvr_(this.mpd),this.muxed=this.muxed_(this.mpd),this.type=this.type_(this.mpd),this.startTime=this.startTime_(this.mpd),this.updatePeriod=this.updatePeriod_(this.mpd),this.adps<0?"Bad adps":"static"==this.type&&-1==this.duration?"Bad duration":this.type<0?"Bad type":"dynamic"==this.type&&this.startTime<0?"Bad start time":"dynamic"==this.type&&this.updatePeriod<0?"Bad update period":null}adps_(e,t,i){const s=n.default.q("Period",e)[0],a=n.default.q("AdaptationSet",s);if(!a||a.length<1)return-1;const o=[];for(let e=0;e!=a.length;e++)o.push(new r.default(a[e],e,t,i));return o}baseURL_(e,t){let i="";return t&&(i=`${t}`),i.length<1&&(i=(i=n.default.q("MPD BaseURL",e)[0])&&i.textContent?i.textContent.trim():"/"),i+("/"!==i.charAt(i.length-1)?"/":"")}duration_(e){const t=n.default.q("MPD",e)[0],i=n.default.a("mediaPresentationDuration",t);return n.default.ndef(i)||!i.hasOwnProperty("length")||i.length<1?-1:(0,o.toDuration)(i)}dvr_(e){const t=n.default.q("MPD",e)[0],i=n.default.a("timeShiftBufferDepth",t);return n.default.ndef(i)||!i.hasOwnProperty("length")||i.length<1?-1:(0,o.toDuration)(i)}muxed_(e){const t=n.default.q("Representation",e)[0];if(!t)return-1;const i=n.default.a("codecs",t);return i.includes("avc")&&i.includes("mp4")}type_(e){const t=n.default.q("MPD",e)[0];let i=n.default.a("type",t);return i&&""!==i.trim()?i.trim():-1}startTime_(e){const t=n.default.q("MPD",e)[0],i=n.default.a("availabilityStartTime",t);return n.default.ndef(i)?-1:new Date(i)}updatePeriod_(e){const t=n.default.q("MPD",e)[0],i=n.default.a("minimumUpdatePeriod",t);return n.default.ndef(i)?-1:(0,o.toDuration)(i)}xml_(e){return e.querySelectorAll?e:(new DOMParser).parseFromString(e,"text/xml",0)}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.State=void 0;var s,n=(s=i(0))&&s.__esModule?s:{default:s},r=i(10),a=i(7),o=i(1),u=i(2),l=i(6),h=i(5);t.State=class{constructor(e={}){this.config=(0,o.mergeDicts)(e,{playlist:[],base:0,lead:0,start:0,timed:0,track:0,query:""}),this.config.query+=this.config.query.match(/(^|\s)video(\s|\.|$)/)?"":" video"}setup(){return new Promise((e,t)=>{const i=document.querySelectorAll(this.config.query)[0];null!==i&&void 0!==i||t("Unable to find root element for insertion query."),i.onerror=(()=>{}),this.video=i,this.paused=!0,this.loading=!1,this.started=!1,this.qualityAuto=!0,this.qualityQueued=null,this.bufferTime=this.config.start,this.config.timed>0?e():this.init_().then(()=>e())})}init_(){return null!==this.mpd&&void 0!==this.mpd?Promise.resolve():new Promise(e=>{const t=this.config.track;this.mpd=new r.MPD({url:this.config.playlist[t].dash.url,base:this.config.playlist[t].dash.base}),this.mpd.setup().then(()=>{}).then(()=>this.mediaSource_()).then(t=>{this.mediaSource=t,this.usingHLS()&&e()}).then(()=>this.usingHLS()?null:this.buildStreams_(this.mpd,this.mediaSource)).then(t=>{this.streams=t,e()})})}buildStreams_(e,t){return new Promise(i=>{let s=0,n=[];for(let r=0;r<e.adps.length;r++){const o=e.adps[r],u=o.reps[o.bestRep()],l=new a.Stream({mediaSource:t,mpd:e,adp:o,rep:u,sources:e.adps[r].reps});l.setup().then(()=>{n.push(l),++s===e.adps.length&&i(n)})}})}mediaSource_(){return new Promise((e,t)=>{if(this.usingHLS())this.video.type=h.hlsMimeType,this.video.src=`data:${h.hlsMimeType};base64,${btoa((0,h.mpdToM3U8)(this))}`,e(null);else{const i=new MediaSource;i.addEventListener("sourceopen",()=>{"open"===i.readyState?e(i):t("Unable to open media source!")}),this.video.src=this.url_(i)}})}url_(e){if(null!==e&&void 0!==e)return URL.createObjectURL(e);throw"Media source is invalid."}adjustQuality(e=1){return this.loading?Promise.resolve(!1):(this.loading=!0,new Promise(t=>{if(this.qualityAuto||null===this.qualityQueued)if(this.qualityAuto)for(let i=0;i<this.streams.length;i++){const s=this.streams[i],n=s.adp;let r;if(e>=.6)r=n.weakerRep(s.rep.id);else{if(!(e<=.3))return this.loading=!1,void t(!1);r=n.strongerRep(s.rep.id)}s.switchToRep(r.id).then(()=>{i===this.streams.length-1&&(this.loading=!1,t(!0))})}else this.loading=!1,t(!1);else{const e=this.qualityQueued.stream,i=this.qualityQueued.repID;this.qualityQueued=null,e.switchToRep(i).then(()=>{this.loading=!1,t(!0)})}}))}audioStream(){if(null===this.streams||void 0===this.streams)return null;for(let e=0;e!=this.streams.length;e++){const t=this.streams[e];if(t.type===u.kStreamType.audio||t.type===u.kStreamType.muxed)return t.rep}return null}codecs(){return this.streams.map(e=>e.codecs())}fillBuffers(e=null){const t="dynamic"===this.mpd.type;if(!t&&this.loading)return Promise.resolve();if(this.started&&this.paused)return Promise.resolve();const i=Date.now(),s=this.segmentLengths().reduce((e,t)=>Math.min(e,t))/2;return t&&this.lastTime&&i-this.lastTime<s?Promise.resolve():new Promise(s=>{const n=this.bufferTime,r=e||(this.started?this.config.lead:this.config.base),a=Math.min(this.mpd.duration,n+r);let o,u=0,h=(new Date).getTime();return t||(this.loading=!0),this.streams.reduce((e,d,c)=>e.then(()=>{let e=d.makePoints(n,t?null:a,i,d.rep),p=d.inCache(e);return(e=e.filter(e=>!p.includes(e))).reduce((n,p,f)=>n.then(()=>d.fillBuffer(p).then(n=>{if(null!==n&&void 0!==n){if(u+=n,c===this.streams.length-1&&f===e.length-1){o=(new Date).getTime();const e=(0,l.kbps)(u,(o-h)/1e3),n=(0,l.speedFactor)(e,u,r);this.bufferTime=a,this.started=!0,this.loading=!1,t&&(this.lastTime=i),s([n,i])}}else s(0)})),Promise.resolve())}),Promise.resolve())})}imageStream(){if(null===this.streams||void 0===this.streams)return null;for(let e=0;e!=this.streams.length;e++){const t=this.streams[e];if(t.type===u.kStreamType.image)return t.rep}return null}pause(){return this.paused=!0,this.video.pause()}play(){return this.paused=!1,this.video.play()}queueQuality(e){const t=e.repID;if("auto"===e.name.toLowerCase())return this.qualityAuto=!0,void(this.qualityQueued=null);for(let e=0;e!=this.streams.length;e++){const i=this.streams[e];for(let e=0;e!=i.sources.length;e++)if(i.sources[e].id===t)return this.qualityAuto=!1,void(this.qualityQueued={stream:i,repID:t})}}segmentLengths(){return this.streams.map(e=>e.segmentLength())}usingHLS(){if(!(0,h.hlsSupported)())return!1;const e=this.config.playlist[this.config.track].hls;return!(!n.default.def(e)||!e.gen&&!e.url)}videoStream(){if(null===this.streams||void 0===this.streams)return null;for(let e=0;e!=this.streams.length;e++){const t=this.streams[e];if(t.type===u.kStreamType.video||t.type===u.kStreamType.muxed)return t.rep}return null}}},function(e,t,i){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Player=void 0;var s,n=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return function(e,t){var i=[],s=!0,n=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(s=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);s=!0);}catch(e){n=!0,r=e}finally{try{!s&&o.return&&o.return()}finally{if(n)throw r}}return i}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")},r=(s=i(0))&&s.__esModule?s:{default:s},a=i(4),o=i(11),u=i(1);class l{constructor(e={}){this.config=(0,u.mergeDicts)(e,{playlist:[],auto:!0,adapt:!0,base:1e3,debug:!1,lead:5e3,loop:!1,query:".pepper",start:0,timed:0,track:0,ui:!0}),this.setup_()}async setup_(){if(!this.config.query.length||this.config.query.length<1)throw"Invalid insertion query.";this.config.base<100&&(this.config.base=100),this.config.lead<1e3&&(this.config.lead=1e3),this.renderUI(),this.state=new o.State(this.config),await this.state.setup();const e=this.state.config.timed;if(e>0)return this.startsInMs=e,void setTimeout(()=>{this.startsInMs=e>=1e3?e-1e3:e,this.updateTimer_(e>=1e3?e-1e3:e)},1e3);this.init_()}async init_(){if(await this.state.init_(),!this.state.usingHLS()){var e=await this.state.fillBuffers(),t=n(e,2);const i=t[0],s=this.state.mpd.type;"dynamic"===s&&(this.safariStartTime=t[1]/1e3),await this.state.adjustQuality(i),this.config.auto&&("dynamic"===s&&a.os.is("safari")&&(this.state.video.currentTime=this.safariStartTime),this.play())}return Promise.resolve()}bufferTime(){return this.state.bufferTime}currentTime(){return null===this.state||void 0===this.state?0:null===this.state.video||void 0===this.state.video?0:1e3*this.state.video.currentTime}didEnd(){return 1e3*Math.round(this.currentTime()/1e3)>=this.duration()}duration(){return this.state.mpd.duration}isPaused(){return null===this.state||void 0===this.state||this.state.paused}makeActive(){}next(){}pause(){return this.state.pause()}async play(){const e=this.state.mpd.type;if(await this.state.play(),"static"===e)this.state.video.ontimeupdate=(async()=>{if(this.currentTime()>=this.bufferTime()-this.config.lead/2){const e=await this.state.fillBuffers();this.state.adjustQuality(e)}return this.didEnd()&&(this.state.video.currentTime=0,this.config.loop||this.pause()),Promise.resolve()});else if("dynamic"===e){const e=this.state.segmentLengths(),t=e.reduce((e,t)=>Math.min(e,t))/2,i=e.reduce((e,t)=>Math.max(e,t));setInterval(async()=>{const e=await this.state.fillBuffers(i);return this.lastSpeed=e,this.config.auto&&!this.isPaused()&&this.state.play(),this.state.adjustQuality(e),Promise.resolve()},this.lastSpeed?t-t*this.lastSpeed:t)}}previous(){}renderUI(){if(!this.injectedUI){const e=r.default.q(this.config.query)[0];if(!r.default.q("video",e)[0]){const t=this.state&&this.state.usingHLS(),i=document.createElement("video");i.controls=!1,i.autoplay=this.config.auto&&!t,i.addEventListener("click",()=>{this.state.video.play().catch(()=>void 0)}),e.appendChild(i)}this.injectedUI=!0}}seek(e){null!==e&&void 0!==e&&(this.config.start=this.state.mpd.duration*(e/100),this.pause(),this.setup_())}updateTimer_(e){e<=0?this.init_():setTimeout(()=>{this.startsInMs-=1e3,this.updateTimer_(e>0?e-1e3:0)},1e3)}}t.default=l,t.Player=l}])});