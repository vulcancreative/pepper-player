!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("pepper",[],e):"object"==typeof exports?exports.pepper=e():t.pepper=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var i={};return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},e.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=13)}([function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i="undefined",s=t=>null===t||typeof t===i;e.default={def:t=>null!==t&&typeof t!==i,ndef:s,a:(t,e)=>e.getAttribute(t),q:(t,e)=>((t,e)=>(s(e)&&(e=document),e=[].slice.call(e.querySelectorAll(t))))(t,e)}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.sizeDict=function(t){return Object.keys(t).length},e.mergeDicts=function(t,e){let i={};for(let s of Object.keys(e))i[s]=null!==t[s]&&void 0!==t[s]?t[s]:e[s];return i},e.randInt=function(t,e){return parseInt(Math.floor(Math.random()*(e-t+1)+t))},e.isInt=function(t){if(isNaN(t))return!1;var e=parseFloat(t);return(0|e)===e}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.kProtocol={hls:"HLS",dash:"DASH"},e.kStreamType={audio:"audio",video:"video",muxed:"muxed",image:"image"},e.kSegmentType={init:"initialization",segment:"segment"},e.kTransitions={countdown:"countdown",immedaite:"immediate"},e.kBackingType={splitX:"splitX",splitY:"splitY",uniform:"uniform"}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.toInt=(t=>{const e=t%1,i=parseInt(t);return isNaN(e)||isNaN(i)?null:i}),e.msToStamp=(t=>{let e="",i=1e3*Math.floor(t>-1?t:0)/1e3,s=0,n=0,r=0;for(;i>=36e5;)i-=36e5,s++;for(;i>=6e4;)i-=6e4,n++;return r=i/1e3,s>0&&(e+=`${s}:`),e+(s>0?`${n.toFixed(0)}`.padStart(2,"0"):`${n}`)+":"+`${r.toFixed(0)}`.padStart(2,"0")}),e.toDuration=(t=>{const e=[0,0,31536e6,254016e4,6048e5,864e5,36e5,6e4,1e3];return t.match(/(-)?P(?:([.,\d]+)Y)?(?:([.,\d]+)M)?(?:([.,\d]+)W)?(?:([.,\d]+)D)?T(?:([.,\d]+)H)?(?:([.,\d]+)M)?(?:([.,\d]+)S)?/).reduce((t,i,s)=>s<2?0:null===i||void 0===i?t+0:t+i*e[s])}),e.arrayBufferToBase64=(t=>{for(var e="",i=new Uint8Array(t),s=i.byteLength,n=0;n<s;n++)e+=String.fromCharCode(i[n]);return btoa(e)})},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s,n=(s=i(0))&&s.__esModule?s:{default:s};let r=0,a=!1;const o=()=>Date.now()-r,u=t=>{const e=n.default.def(t)?new Date(t):new Date,i=Date.now()-o();return a?new Date(e.getTime()-i):e};e.default={init:u,now:o,parse:t=>u(t),sync:t=>{r=0,r=o()-t,a=!0},synced:()=>a}},function(t,e){"use strict";var i,s,n;Object.defineProperty(e,"__esModule",{value:!0}),e.os=(i=navigator,s=(i.userAgent+" "+i.oscpu).toLowerCase(),n={is:function(t,e){switch(e=/bot|spider|crawl|seeker/,t=t.toLowerCase()){case"safari":return/^((?!chrome).)*safari/.test(s);default:return~s.search(t)||e.test(s)}}}),e.os=n},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.repToM3U8=e.mpdToM3U8=e.hlsPreferred=e.hlsSupported=e.hlsMimeType=void 0;var s=i(5),n=i(2);const r="application/vnd.apple.mpegurl",a=()=>{let t=document.createElement("video");return t.canPlayType&&!!t.canPlayType("application/vnd.apple.mpegurl")},o=(t,e)=>{const i=t.mpd,s=e.segmentLength(),n=((t,e,i)=>{let s;const n=t.mpd;if("dynamic"===n.type){const n=new Date,r=(new Date).setSeconds(n.getSeconds()+28800);s=function(t){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t){var e=[],i=!0,s=!1,n=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done)&&(e.push(r.value),1!==e.length);i=!0);}catch(t){s=!0,n=t}finally{try{!i&&a.return&&a.return()}finally{if(s)throw n}}return e}(t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}(e.makePoints(t.mpd,n,r,e,80))[0].map(t=>`#EXTINF:${parseFloat(i/1e3).toFixed(5)},\n${e.mediaURL(t)}`)}else{const t=Math.ceil(n.duration/i);s=Array(t).fill().map((t,s)=>`#EXTINF:${parseFloat(i/1e3).toFixed(5)},\n${e.mediaURL(s+1)}`)}return s})(t,e,s),a="#EXTM3U\n"+`#EXT-X-TARGETDURATION:${parseInt(Math.ceil(s/1e3))}\n`+"#EXT-X-VERSION:7\n"+`#EXT-X-PLAYLIST-TYPE:${"static"===i.type?"VOD":"EVENT"}\n`+"#EXT-X-INDEPENDENT-SEGMENTS\n"+`#EXT-X-MAP:URI="${e.initURL()}"\n`+n.join("\n")+"\n"+`${"static"===i.type?"#EXT-X-ENDLIST":""}`,o=new Blob([a],{type:r});return URL.createObjectURL(o)};e.hlsMimeType=r,e.hlsSupported=a,e.hlsPreferred=(()=>!s.os.is("chrome")&&(a(),!1)),e.mpdToM3U8=(t=>{const e=[].concat(...t.mpd.adps.map(t=>t.reps)),i=e.filter(t=>t.type===n.kStreamType.audio),s=e.filter(t=>t.type===n.kStreamType.video),r=i.map(e=>{const i=o(t,e);return"#EXT-X-MEDIA:TYPE=AUDIO,"+`GROUP-ID="${e.id}",`+`NAME="${e.id}",`+'LANGUAGE="en-US",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2",'+`URI="${i}"`}),a=s.map(e=>{const s=o(t,e);return"#EXT-X-STREAM-INF:"+`BANDWIDTH=${e.bandwidth},`+`CODECS="${e.codecs},${i[0].codecs}",`+`RESOLUTION=${e.width}x${e.height},`+`AUDIO="${i[0].id}"\n`+`${s}`});return"#EXTM3U\n#EXT-X-VERSION:6\n#EXT-X-INDEPENDENT-SEGMENTS\n"+r.join("\n")+"\n"+a.join("\n")}),e.repToM3U8=o},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.kbps=function(t,e){const i=((8*t/e).toFixed(2)/1024).toFixed(2);return parseFloat(i)},e.speedFactor=function(t,e,i){const s=i/1e3,n=(parseFloat(8*e/(1024*t))/parseFloat(s)).toFixed(2);return parseFloat(n)}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Stream=void 0;var s=i(1),n=i(3),r=i(2);e.Stream=class{constructor(t={}){this.config=(0,s.mergeDicts)(t,{adp:null,id:null,mediaSource:null,mpd:null,sources:null}),this.mediaSource=this.config.mediaSource,this.adp=this.config.adp,this.id=this.config.id,this.mpd=this.config.mpd,this.sources=this.config.sources,this.mpdWasUpdated=!1}setup(){return new Promise(t=>{this.init_().then(e=>{this.cache=e,t()})})}init_(t=[]){return new Promise(e=>{const i=this.mpd.repByID(this.id);if(this.type=i.type,this.codecs=`${i.mimeType}; codecs="${i.codecs}"`,MediaSource.isTypeSupported(this.codecs)){this.buffer=this.mediaSource.addSourceBuffer(this.codecs),this.buffer.mode="sequence","dynamic"===this.mpd.type&&(this.buffer.timestampOffset=.1);for(let s=0;s!=this.sources.length;s++){const n=this.sources[s],a=n.initURL();this.fetchSegment_(a).then(a=>{if(t.push({type:r.kSegmentType.init,rep:n.id,point:0,data:a,size:a.byteLength}),s===this.sources.length-1)for(let s=0;s!=t.length;s++){const n=t[s];0===n.point&&n.rep===i.id&&this.appendBuffer(this.buffer,n).then(i=>{this.buffer=i,e(t)})}})}}else e(t)})}fetchSegment_(t=""){return new Promise((e,i)=>{const s=this.mpd.repByID(this.id).id,n=this.mpd.type,r=new XMLHttpRequest;r.onload=function(){r.status>=400&&"dynamic"===n?e(null):r.status>=200&&r.status<400?e(r.response):i(`Unable to fetch segment at "${t}" for rep "${s}"`)},r.open("GET",t),r.responseType="arraybuffer",r.send()})}appendBuffer(t,e){return new Promise((i,s)=>{this.mpd.repByID(this.id),null!==t&&void 0!==t||s("Buffer invalid!"),null!==e&&void 0!==e||s("Segment invalid!");try{t.appendBuffer(new Uint8Array(e.data))}catch(t){}t.onupdateend=(()=>i(t))})}bufferedLength(){const t=this.cache.length;return t<2?0:Math.round((t-1)*this.segmentLength())}fillBuffer(t){return new Promise(e=>{const i=this.mpd.repByID(this.id),s=i.mediaURL(t);this.fetchSegment_(s).catch(()=>{}).then(s=>{if(null!==s&&void 0!==s)return this.type===r.kStreamType.image?(this.cache.push({point:t,mime:i.mimeType,data:(0,n.arrayBufferToBase64)(s),info:i.tileInfo}),void e(s.byteLength)):(this.cache.push({type:r.kSegmentType.segment,point:t,data:s,size:s.byteLength}),void this.appendBuffer(this.buffer,this.cache[this.cache.length-1]).then(t=>{this.buffer=t,e(s.byteLength)}));e(null)})})}inCache(t=[]){let e=[];for(let i=0;i<t.length;i++){const s=t[i];for(let t=0;t<this.cache.length;t++)this.cache[i].point===s&&e.push(s)}return e}makePoints(t,e,i,s){const n=this.mpd.repByID(s);let r,a=this.lastPoint||0;var o=function(t){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t){var e=[],i=!0,s=!1,n=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done)&&(e.push(r.value),2!==e.length);i=!0);}catch(t){s=!0,n=t}finally{try{!i&&a.return&&a.return()}finally{if(s)throw n}}return e}(t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}(n.makePoints(this.mpd,t,e,i,a));return r=o[0],this.lastPoint=a=o[1],r}popCache(t=1){return new Promise((e,i)=>{let s=0;this.cache.length<t+1&&e();for(let t=1;t<this.cache.length;t++)if(this.cache[t].type!==r.kSegmentType.init&&this.cache[t-1].type===r.kSegmentType.init&&this.cache[t].type===r.kSegmentType.segment){s=t;break}0===s&&i(),s+1+t>this.cache.length&&i(),this.cache.splice(s,t),e()})}segmentLength(){const t=this.mpd.repByID(this.id);if(null===t&&void 0===t)throw`Unable to determine segment length of rep "${t.id}"`;return t.segmentLength()}switchToRep(t){return new Promise(e=>{for(let i=0;i!=this.cache.length;i++){const s=this.cache[i];0===s.point&&s.rep===t&&this.appendBuffer(this.buffer,s).then(i=>{this.buffer=i;for(let e=0;e!=this.sources.length;e++){const i=this.sources[e];if(i.id===t){this.id=i.id;break}}e()})}})}updateMPD(){this.mpdWasUpdated=!0}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s,n=(s=i(0))&&s.__esModule?s:{default:s},r=i(3),a=i(2);e.default=class{constructor(t,e,i,s,o){let u,l,d,h,c,p,f,m,y,g,v,T,b,S,w,P,_,I;this.presentationTime=o,u=n.default.a("id",e),w=n.default.a("mimeType",t),n.default.ndef(w)&&(w=n.default.a("mimeType",e)),l=n.default.a("codecs",e);const M=n.default.a("width",e),D=n.default.a("height",e);d=(0,r.toInt)(M)||0,h=(0,r.toInt)(D)||0;const L=n.default.a("bandwidth",e);c=(0,r.toInt)(L),p=s||"";const E=i.split("/"),U=E.length;if(p=U>1?E.slice(0,U-1).join("/"):"/",p+="/"===p.charAt(p.length-1)?"":"/",y=n.default.q("SegmentTimeline",t)[0],n.default.def(y)){const t=[...y.children];T=t,v=this.timeline_(t)}if((g=n.default.q("SegmentTemplate",t)[0])||(g=n.default.q("SegmentTemplate",e)[0]),g){m=n.default.a("media",g),f=n.default.a("initialization",g),n.default.def(f)&&(f=f.replace("$RepresentationID$",u));const t=n.default.a("startNumber",g);b=(0,r.toInt)(t);const e=n.default.a("timescale",g);S=(0,r.toInt)(e);const i=n.default.a("duration",g);P=(0,r.toInt)(i)}if(w&&w.includes("video")&&d&&h?_=a.kStreamType.video:w&&w.includes("audio")&&c?_=a.kStreamType.audio:w&&w.includes("image")&&(_=a.kStreamType.image),_===a.kStreamType.image){let t="1x1";const i=n.default.a("duration",g),s=n.default.q("EssentialProperty",e)[0];s&&(t=n.default.a("value",s)),I={duration:1e3*parseInt(i),count:parseInt(t.split("x")[0]),width:d,height:h}}this.id=u,this.mimeType=w,this.codecs=l,this.width=d,this.height=h,this.bandwidth=c,this.baseURL=p,this.timelineParts=T,this.timeline=v,this.mediaTemplate=m,this.initialization=f,this.startNumber=b,this.timescale=S,this.segmentDuration=P,this.tileInfo=I,this.type=_}initURL(){const t=this.initialization,e=this.baseURL;return(e?`${e}${t}`:t).replace(/\$RepresentationID\$/g,`${this.id}`)}makePoints(t,e,i,s,r=0){return n.default.def(this.timeline)?this.makeTimelinePoints(r):[this.makeTemplatePoints(t,e,i,s),null]}makeTimelinePoints(t){let e,i=0,s=t;for(;s<=t;)s=e=this.timeline[i],i++;if(t===e)throw"last === result";return[[e],e]}makeTemplatePoints(t,e,i,s){const n=this.segmentLength();if("static"===t.type){if(this.type===a.kStreamType.image&&null!==this.tileInfo){const e=Math.ceil(t.duration/this.tileInfo.duration);return new Array(e).fill(0).map((t,e)=>e+1)}const s=parseInt(Math.ceil(parseFloat((i<e?e+1e3:i)-e)/parseFloat(n))),r=parseInt(Math.ceil(parseFloat(e)/parseFloat(n)));return new Array(s).fill(r).map((t,e)=>t+(e+1))}if("dynamic"===t.type){const e=Math.abs(s-t.startTime);return i&&i>s?Array(1+(i-s)/n).fill().map((t,i)=>(e+n*i)/n-10):[Math.ceil(e/n-10)]}throw`Unable to decipher source type ("${t.type}")`}mediaURL(t){const e=/\$Time\$/g,i=/\$Number\$/g,s=`${t}`;let n=this.mediaTemplate.replace(/\$RepresentationID\$/g,`${this.id}`);if(e.test(n)&&this.timeline.length>0)n=n.replace(e,s);else if(/(\$Number%(\d+)d\$)/g.test(n)){const t=/(\$Number%(\d+)d\$)/g.exec(n),e=parseInt(t[t.length-1])+1,r=s.padStart(e-1,"0");n=(n=n.replace(t[0],r)).replace(i,s)}else n=n.replace(i,s);const r=this.baseURL;return r?`${r}${n}`:n}segmentLength(){if(this.timelineParts&&this.timelineParts.length>0){const t=[];for(let e=0;e<this.timelineParts.length;e++){const i=this.timescale,s=parseInt(this.timelineParts[e].getAttribute("d"));t.push(s/i)}if(t.length>0)return t.reduce((t,e)=>t+e)/t.length*1e3}const t=parseFloat(this.timescale),e=parseFloat(this.segmentDuration);if(null===t&&void 0===t||isNaN(t))return 1e3*e;const i=Math.floor(e/t);return 1e3*parseInt(i)}weight(){return this.width+this.height+this.bandwidth}timeline_(t){let e=[],i=0;for(let s=0;s!=t.length;s++){const r=t[s];let a=parseInt(n.default.a("t",r)),o=parseInt(n.default.a("d",r)),u=parseInt(n.default.a("r",r));a-=this.presentationTime,u=isNaN(u)||u<1?1:u;let l=n.default.def(a)&&!isNaN(a)?a:i;for(let t=0;t!=u;t++){let t=l+o;e.push(t),i=t}}return e}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var n=s(i(0)),r=s(i(9)),a=i(3);e.default=class{constructor(t,e,i,s,r){const o=n.default.a("maxWidth",t),u=n.default.a("maxHeight",t);this.adp=t,this.index=e,this.maxWidth=(0,a.toInt)(o),this.maxHeight=(0,a.toInt)(u),this.reps=this.reps_(t,i,s,r)}reps_(t,e,i,s){const a=n.default.q("Representation",t);if(a&&a.length>0){let o=[];for(let n=0;n!=a.length;n++)o.push(new r.default(t,a[n],e,i,s));const u=o.map(t=>n.default.ndef(t.bandwidth)?null:t.bandwidth);if(u.includes(null)){const t=u.findIndex(t=>null!==t),e=t>-1?u[t]:0;o=o.map(t=>(t.bandwidth=e,t))}return o.sort((t,e)=>t.weight()<e.weight()?-1:t.weight()>e.weight()?1:0),o}throw`No representations present in adaptation[${this.index}]`}bestRep(){return this.reps.length-1}strongerRep(t){let e;const i=this.reps;for(let s=0;s!=i.length;s++)if(i[s].id===t){e=i[s];break}let s=e,n=e.weight();for(let t=0;t!=i.length;t++)if(i[t].weight()>n){s=i[t];break}return s}weakerRep(t){let e;const i=this.reps.slice().reverse();for(let s=0;s!=i.length;s++)if(i[s].id===t){e=i[s];break}let s=e,n=e.weight();for(let t=0;t!=i.length;t++)if(i[t].weight()<n){s=i[t];break}return s}worstRep(){return 0}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.MPD=void 0;var n=s(i(0)),r=s(i(10)),a=s(i(4)),o=i(1),u=i(3);e.MPD=class{constructor(t={}){this.config=(0,o.mergeDicts)(t,{url:"",base:"",data:null}),this.fetchedOnce=!1}async setup(){const t=await this.fetch_(this.config.url,this.config.data),e=this.parse_(t);if(e)throw e;return this}fetch_(t="",e){return new Promise(i=>{n.default.def(e)&&i(e,"data");const s=new XMLHttpRequest;s.onload=(()=>{const t=s.response;if(this.fetchedOnce||(this.fetchedOnce=!0),n.default.def(t)&&t.includes('"dynamic"')){const t=s.getResponseHeader("Date"),e=new Date(t);a.default.sync(e)}i(t,"xml")}),s.open("GET",t),s.send()})}parse_(t=""){const e=this.config.url,i=this.config.base;return this.mpd=this.xml_(t),this.baseURL=this.baseURL_(this.mpd,i),this.startTime=this.startTime_(this.mpd),this.adps=this.adps_(this.mpd,e,this.baseURL,this.startTime),this.duration=this.duration_(this.mpd),this.dvr=this.dvr_(this.mpd),this.muxed=this.muxed_(this.mpd),this.type=this.type_(this.mpd),this.updatePeriod=this.updatePeriod_(this.mpd),this.adps<0?"Bad adps":"static"==this.type&&-1==this.duration?"Bad duration":this.type<0?"Bad type":"dynamic"==this.type&&(-1==this.startTime||isNaN(this.startTime)||n.default.ndef(this.startTime))?"Bad start time":"dynamic"==this.type&&this.updatePeriod<0?"Bad update period":null}adps_(t,e,i,s){const a=n.default.q("Period",t)[0],o=n.default.q("AdaptationSet",a);if(!o||o.length<1)return-1;const u=[];for(let t=0;t!=o.length;t++)u.push(new r.default(o[t],t,e,i,s));return u}baseURL_(t,e){let i="";return e&&(i=`${e}`),i.length<1&&(i=(i=n.default.q("MPD BaseURL",t)[0])&&i.textContent?i.textContent.trim():"/"),i+("/"!==i.charAt(i.length-1)?"/":"")}duration_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("mediaPresentationDuration",e);return n.default.ndef(i)||!i.hasOwnProperty("length")||i.length<1?-1:(0,u.toDuration)(i)}dvr_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("timeShiftBufferDepth",e);return n.default.ndef(i)||!i.hasOwnProperty("length")||i.length<1?-1:(0,u.toDuration)(i)}muxed_(t){const e=n.default.q("Representation",t)[0];if(!e)return-1;const i=n.default.a("codecs",e);return i.includes("avc")&&i.includes("mp4")}type_(t){const e=n.default.q("MPD",t)[0];let i=n.default.a("type",e);return i&&""!==i.trim()?i.trim():-1}startTime_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("availabilityStartTime",e);return n.default.ndef(i)?-1:a.default.parse(i)}updatePeriod_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("minimumUpdatePeriod",e);if(n.default.ndef(i))return-1;const s=(0,u.toDuration)(i);return s<1e3?1e3:s}xml_(t){return t.querySelectorAll?t:(new DOMParser).parseFromString(t,"text/xml",0)}repByID(t){for(let e=0;e<this.adps.length;e++){const i=this.adps[e];for(let e=0;e<i.reps.length;e++){const s=i.reps[e];if(s.id===t)return s}}throw`Unable to find rep with ID '${t}'`}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.State=void 0;var n=s(i(0)),r=s(i(4)),a=i(11),o=i(8),u=i(1),l=i(2),d=i(7),h=i(6);e.State=class{constructor(t={}){this.config=(0,u.mergeDicts)(t,{playlist:[],base:0,lead:0,start:0,timed:0,track:0,query:""}),this.config.query+=this.config.query.match(/(^|\s)video(\s|\.|$)/)?"":" video"}setup(){return new Promise((t,e)=>{const i=document.querySelectorAll(this.config.query)[0];null!==i&&void 0!==i||e("Unable to find root element for insertion query."),i.onerror=(()=>{}),this.video=i,this.paused=!0,this.loading=!1,this.started=!1,this.qualityAuto=!0,this.qualityQueued=null,this.bufferTime=this.config.start,this.config.timed>0?t():(this.mpdUpdateInterval&&clearInterval(this.mpdUpdateInterval),this.init_().then(()=>t()))})}init_(){return null!==this.mpd&&void 0!==this.mpd?Promise.resolve():new Promise(t=>{const e=this.config.track;this.mpd=new a.MPD({url:this.config.playlist[e].dash.url,base:this.config.playlist[e].dash.base}),this.mpd.setup().then(()=>this.mediaSource_()).then(e=>{this.mediaSource=e,this.usingHLS()&&t()}).then(()=>this.usingHLS()?null:this.buildStreams_(this.mpd,this.mediaSource)).then(e=>{this.streams=e,"dynamic"===this.mpd.type&&(this.mpdUpdateInterval=setInterval(()=>{this.mpd.setup()},this.mpd.updatePeriod)),t()})})}buildStreams_(t,e){return new Promise(i=>{let s=0,n=[];for(let r=0;r<t.adps.length;r++){const a=t.adps[r],u=a.reps[a.bestRep()],l=new o.Stream({adp:a,id:u.id,mediaSource:e,mpd:t,sources:t.adps[r].reps});l.setup().then(()=>{n.push(l),++s===t.adps.length&&i(n)})}})}mediaSource_(){return new Promise((t,e)=>{if(this.usingHLS())this.video.type=h.hlsMimeType,this.video.src=`data:${h.hlsMimeType};base64,${btoa((0,h.mpdToM3U8)(this))}`,t(null);else{const i=new MediaSource;i.addEventListener("sourceopen",()=>{"open"===i.readyState?t(i):e("Unable to open media source!")}),this.video.src=this.url_(i)}})}url_(t){if(null!==t&&void 0!==t)return URL.createObjectURL(t);throw"Media source is invalid."}adjustQuality(t=1){return this.loading?Promise.resolve(!1):(this.loading=!0,new Promise(e=>{if(this.qualityAuto||null===this.qualityQueued)if(this.qualityAuto)for(let i=0;i<this.streams.length;i++){const s=this.streams[i],n=s.adp;let r;if(t>=.6)r=n.weakerRep(s.id);else{if(!(t<=.3))return this.loading=!1,void e(!1);r=n.strongerRep(s.id)}s.switchToRep(r.id).then(()=>{i===this.streams.length-1&&(this.loading=!1,e(!0))})}else this.loading=!1,e(!1);else{const t=this.qualityQueued.stream,i=this.qualityQueued.repID;this.qualityQueued=null,t.switchToRep(i).then(()=>{this.loading=!1,e(!0)})}}))}audioStream(){if(null===this.streams||void 0===this.streams)return null;for(let t=0;t!=this.streams.length;t++){const e=this.streams[t];if(e.type===l.kStreamType.audio||e.type===l.kStreamType.muxed)return e.rep}return null}codecs(){return this.streams.map(t=>t.codecs())}fillBuffers(t=null){const e="dynamic"===this.mpd.type;if(this.loading)return Promise.resolve();if(this.started&&this.paused)return Promise.resolve();const i=r.default.now(),s=this.segmentLengths().reduce((t,e)=>Math.min(t,e))/2;return e&&this.lastTime&&i-this.lastTime<s?Promise.resolve():new Promise(s=>{const a=this.bufferTime,o=t||(this.started?this.config.lead:this.config.base),u=Math.min(this.mpd.duration,a+o),l=u<0?0:u;let h,c=0,p=r.default.init().getTime();return this.loading=!0,this.streams.reduce((t,u,f)=>t.then(()=>{let t=u.makePoints(a,e?null:l,i,u.id);t=t.filter(t=>n.default.def(t));let m=u.inCache(t);return(t=t.filter(t=>!m.includes(t))).reduce((e,a,m)=>e.then(()=>u.fillBuffer(a).then(e=>{if(n.default.ndef(e))s(0);else if(c+=e,f===this.streams.length-1&&m===t.length-1){h=r.default.init().getTime();const t=(0,d.kbps)(c,(h-p)/1e3),e=(0,d.speedFactor)(t,c,o);this.bufferTime=l,this.started=!0,this.loading=!1,this.lastTime=r.default.now(),s([e,i])}})),Promise.resolve())}),Promise.resolve())})}imageStream(){if(null===this.streams||void 0===this.streams)return null;for(let t=0;t!=this.streams.length;t++){const e=this.streams[t];if(e.type===l.kStreamType.image)return e.rep}return null}pause(){return this.paused=!0,this.video.pause()}play(){return this.paused=!1,this.video.play()}queueQuality(t){const e=t.repID;if("auto"===t.name.toLowerCase())return this.qualityAuto=!0,void(this.qualityQueued=null);for(let t=0;t!=this.streams.length;t++){const i=this.streams[t];for(let t=0;t!=i.sources.length;t++)if(i.sources[t].id===e)return this.qualityAuto=!1,void(this.qualityQueued={stream:i,repID:e})}}segmentLengths(){return this.streams.map(t=>t.segmentLength())}usingHLS(){if(!(0,h.hlsSupported)())return!1;const t=this.config.playlist[this.config.track].hls;return!(!n.default.def(t)||!t.gen&&!t.url)}videoStream(){if(null===this.streams||void 0===this.streams)return null;for(let t=0;t!=this.streams.length;t++){const e=this.streams[t];if(e.type===l.kStreamType.video||e.type===l.kStreamType.muxed)return e.rep}return null}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Player=void 0;var s,n=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var i=[],s=!0,n=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(s=(a=o.next()).done)&&(i.push(a.value),!e||i.length!==e);s=!0);}catch(t){n=!0,r=t}finally{try{!s&&o.return&&o.return()}finally{if(n)throw r}}return i}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},r=(s=i(0))&&s.__esModule?s:{default:s},a=i(5),o=i(12),u=i(1);class l{constructor(t={}){this.config=(0,u.mergeDicts)(t,{playlist:[],auto:!0,adapt:!0,base:1e3,debug:!1,lead:5e3,loop:!1,query:".pepper",start:0,timed:0,track:0,ui:!0}),this.setup_()}async setup_(){if(!this.config.query.length||this.config.query.length<1)throw"Invalid insertion query.";this.config.base<100&&(this.config.base=100),this.config.lead<1e3&&(this.config.lead=1e3),this.renderUI(),this.state=new o.State(this.config),await this.state.setup();const t=this.state.config.timed;if(t>0)return this.startsInMs=t,void setTimeout(()=>{this.startsInMs=t>=1e3?t-1e3:t,this.updateTimer_(t>=1e3?t-1e3:t)},1e3);this.init_()}async init_(){if(await this.state.init_(),!this.state.usingHLS()){var t=await this.state.fillBuffers(),e=n(t,2);const i=e[0],s=this.state.mpd.type;"dynamic"===s&&(this.safariStartTime=e[1]/1e3),await this.state.adjustQuality(i),this.config.auto&&("dynamic"===s&&a.os.is("safari")&&(this.state.video.currentTime=this.safariStartTime),this.play())}return Promise.resolve()}bufferTime(){return this.state.bufferTime}currentTime(){return null===this.state||void 0===this.state?0:null===this.state.video||void 0===this.state.video?0:1e3*this.state.video.currentTime}didEnd(){return 1e3*Math.round(this.currentTime()/1e3)>=this.duration()}duration(){return this.state.mpd.duration}isPaused(){return null===this.state||void 0===this.state||this.state.paused}makeActive(){}next(){}pause(){return this.state.pause()}async play(){const t=this.state.mpd.type;if(await this.state.play(),"static"===t)this.state.video.ontimeupdate=(async()=>{if(this.currentTime()>=this.bufferTime()-this.config.lead/2){const t=await this.state.fillBuffers();this.state.adjustQuality(t)}return this.didEnd()&&(this.state.video.currentTime=0,this.config.loop||this.pause()),Promise.resolve()});else if("dynamic"===t){const t=this.state.segmentLengths(),e=t.reduce((t,e)=>Math.min(t,e))/2,i=t.reduce((t,e)=>Math.max(t,e));setInterval(async()=>{const t=await this.state.fillBuffers(i);return this.lastSpeed=t,this.config.auto&&!this.isPaused()&&this.state.play(),this.state.adjustQuality(t),Promise.resolve()},this.lastSpeed?i-e*this.lastSpeed:e)}}previous(){}renderUI(){if(!this.injectedUI){const t=r.default.q(this.config.query)[0];if(!r.default.q("video",t)[0]){const e=this.state&&this.state.usingHLS(),i=document.createElement("video");i.controls=!1,i.autoplay=this.config.auto&&!e,i.addEventListener("click",()=>{this.state.video.play().catch(()=>void 0)}),t.appendChild(i)}this.injectedUI=!0}}seek(t){null!==t&&void 0!==t&&(this.config.start=this.state.mpd.duration*(t/100),this.pause(),this.setup_())}updateTimer_(t){t<=0?this.init_():setTimeout(()=>{this.startsInMs-=1e3,this.updateTimer_(t>0?t-1e3:0)},1e3)}}e.default=l,e.Player=l}])});