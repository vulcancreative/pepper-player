!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define("pepper",[],e):"object"==typeof exports?exports.pepper=e():t.pepper=e()}("undefined"!=typeof self?self:this,function(){return function(t){function e(s){if(i[s])return i[s].exports;var n=i[s]={i:s,l:!1,exports:{}};return t[s].call(n.exports,n,n.exports,e),n.l=!0,n.exports}var i={};return e.m=t,e.c=i,e.d=function(t,i,s){e.o(t,i)||Object.defineProperty(t,i,{configurable:!1,enumerable:!0,get:s})},e.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},e.n=function(t){var i=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(i,"a",i),i},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=14)}([function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=t=>null!==t&&void 0!==t,s=t=>!i(t);e.default={def:i,ndef:s,fnc:t=>i(t)&&"function"==typeof t.call,a:(t,e)=>e.getAttribute(t),q:(t,e)=>((t,e)=>(s(e)&&(e=document),e=[].slice.call(e.querySelectorAll(t))))(t,e)}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.kMPDType={static:"static",dynamic:"dynamic"},e.kProtocol={hls:"HLS",dash:"DASH"},e.kStreamType={audio:"audio",video:"video",muxed:"muxed",image:"image"},e.kSegmentType={init:"initialization",segment:"segment"},e.kTransitions={countdown:"countdown",immedaite:"immediate"},e.kBackingType={splitX:"splitX",splitY:"splitY",uniform:"uniform"}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.sizeDict=function(t){return Object.keys(t).length},e.mergeDicts=function(t,e){let i={};for(let s of Object.keys(e))i[s]=null!==t[s]&&void 0!==t[s]?t[s]:e[s];return i},e.randInt=function(t,e){return parseInt(Math.floor(Math.random()*(e-t+1)+t))},e.isInt=function(t){if(isNaN(t))return!1;var e=parseFloat(t);return(0|e)===e}},function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.toInt=(t=>{const e=t%1,i=parseInt(t);return isNaN(e)||isNaN(i)?null:i}),e.msToStamp=(t=>{let e="",i=1e3*Math.floor(t>-1?t:0)/1e3,s=0,n=0,r=0;for(;i>=36e5;)i-=36e5,s++;for(;i>=6e4;)i-=6e4,n++;return r=i/1e3,s>0&&(e+=`${s}:`),e+(s>0?`${n.toFixed(0)}`.padStart(2,"0"):`${n}`)+":"+`${r.toFixed(0)}`.padStart(2,"0")}),e.toDuration=(t=>{const e=[0,0,31536e6,254016e4,6048e5,864e5,36e5,6e4,1e3];return t.match(/(-)?P(?:([.,\d]+)Y)?(?:([.,\d]+)M)?(?:([.,\d]+)W)?(?:([.,\d]+)D)?T(?:([.,\d]+)H)?(?:([.,\d]+)M)?(?:([.,\d]+)S)?/).reduce((t,i,s)=>s<2?0:null===i||void 0===i?t+0:t+i*e[s])}),e.arrayBufferToBase64=(t=>{for(var e="",i=new Uint8Array(t),s=i.byteLength,n=0;n<s;n++)e+=String.fromCharCode(i[n]);return btoa(e)})},function(t,e){"use strict";function i(t,e){const i=(8*(e<1?t*(1/e):t)/e).toFixed(2);return parseFloat(i)}function s(){if(n.length<1)return 0;const t=(n.reduce((t,e)=>t+e,0)/n.length).toFixed(2);return parseFloat(t)}Object.defineProperty(e,"__esModule",{value:!0});const n=[];e.bps=i,e.kbps=function(t,e){return parseFloat((i(t,e)/1024).toFixed(2))},e.bpsAvg=s,e.kbpsAvg=function(){return(s()/1024).toFixed(2)},e.speedFactor=function(t,e,i){const s=i/1e3,n=(parseFloat(8*e/(1024*t))/parseFloat(s)).toFixed(2);return parseFloat(n)},e.pushBpsHistory=function(t){for(n.push(t);n.length>15;)n.shift()},e.clearBpsHistory=function(){for(;n.length>0;)n.shift()}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s,n=(s=i(0))&&s.__esModule?s:{default:s};e.default=class{constructor(t){this.hooks=t||{}}run(t,...e){return new Promise(()=>{const i=this.hooks[t];n.default.def(i)&&n.default.fnc(i)&&i(...e)})}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s,n=(s=i(0))&&s.__esModule?s:{default:s};let r=0,a=!1;const o=()=>Date.now()-r,u=t=>{const e=n.default.def(t)?new Date(t):new Date,i=Date.now()-o();return a?new Date(e.getTime()-i):e};e.default={init:u,now:o,parse:t=>u(t),sync:t=>{r=0,r=o()-t,a=!0},synced:()=>a}},function(t,e){"use strict";var i,s,n;Object.defineProperty(e,"__esModule",{value:!0}),e.os=(i=navigator,s=(i.userAgent+" "+i.oscpu).toLowerCase(),n={is:function(t,e){switch(e=/bot|spider|crawl|seeker/,t=t.toLowerCase()){case"safari":return/^((?!chrome).)*safari/.test(s);default:return~s.search(t)||e.test(s)}}}),e.os=n},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.repToM3U8=e.mpdToM3U8=e.hlsPreferred=e.hlsSupported=e.hlsMimeType=void 0;var s=i(1);const n="\n",r="application/vnd.apple.mpegurl",a=()=>{let t=document.createElement("video");return t.canPlayType&&!!t.canPlayType("application/vnd.apple.mpegurl")&&!("MediaSource"in window)},o=(t,e)=>{const i=t.mpd,a=e.segmentLength(),o=((t,e,i)=>{const n=t.mpd;return(n.type===s.kMPDType.dynamic?e.timeline.slice(0,10):Array(Math.ceil(n.duration/i)).fill()).map((t,r)=>`#EXTINF:${parseFloat(i/1e3).toFixed(5)},\n    https:${e.mediaURL(n.type===s.kMPDType.dynamic?t:r+1)}`)})(t,e,a),u="#EXTM3U\n"+`#EXT-X-TARGETDURATION:${parseInt(Math.ceil(a/1e3))}\n`+"#EXT-X-VERSION:7\n"+`#EXT-X-PLAYLIST-TYPE:${i.type===s.kMPDType.static?"VOD":"EVENT"}\n`+"#EXT-X-INDEPENDENT-SEGMENTS\n"+`#EXT-X-MAP:URI="https:${e.initURL()}"\n`+o.join(n)+n+`${i.type===s.kMPDType.static?"#EXT-X-ENDLIST":""}`,d=new Blob([u],{type:r});return URL.createObjectURL(d)};e.hlsMimeType=r,e.hlsSupported=a,e.hlsPreferred=(()=>a()),e.mpdToM3U8=(t=>{const e=[].concat(...t.mpd.adps.map(t=>t.reps)),i=e.filter(t=>t.type===s.kStreamType.audio),r=e.filter(t=>t.type===s.kStreamType.video),a=i.map(e=>{const i=o(t,e);return"#EXT-X-MEDIA:TYPE=AUDIO,"+`GROUP-ID="${e.id}",`+`NAME="${e.id}",`+'LANGUAGE="en-US",AUTOSELECT=YES,DEFAULT=YES,CHANNELS="2",'+`URI="${i}"`}),u=r.map(e=>{const s=o(t,e);return"#EXT-X-STREAM-INF:"+`BANDWIDTH=${e.bandwidth},`+`CODECS="${e.codecs},${i[0].codecs}",`+`RESOLUTION=${e.width}x${e.height},`+`AUDIO="${i[0].id}"\n`+`${s}`});return"#EXTM3U\n#EXT-X-VERSION:7\n#EXT-X-INDEPENDENT-SEGMENTS\n"+a.join(n)+n+u.join(n)}),e.repToM3U8=o},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Stream=void 0;var n=s(i(0)),r=s(i(5)),a=i(4),o=i(2),u=i(3),d=i(1);e.Stream=class{constructor(t={},e=new r.default){this.config=(0,o.mergeDicts)(t,{adp:null,id:null,mediaSource:null,mpd:null,sources:null}),this.hooks=e,this.mediaSource=this.config.mediaSource,this.adp=this.config.adp,this.id=this.config.id,this.mpd=this.config.mpd,this.sources=this.config.sources,this.mpdWasUpdated=!1}setup(){return new Promise(async t=>{this.cache=await this.init_(),t()})}init_(t=[]){return new Promise(async e=>{const i=this.rep();if(this.type=i.type,this.codecs=`${i.mimeType}; codecs="${i.codecs}"`,!MediaSource.isTypeSupported(this.codecs))return void e(t);this.buffer=this.mediaSource.addSourceBuffer(this.codecs),this.buffer.mode="sequence",this.mpd.type===d.kMPDType.dynamic&&(this.buffer.timestampOffset=.1);let s=!1;const n=await Promise.all(this.sources.map(e=>new Promise(i=>{const n=e.initURL();this.fetchSegment_(n).then(n=>{s||(this.hooks.run("onBufferStart"),s=!0);const r={type:d.kSegmentType.init,rep:e.id,point:0,data:n,size:n.byteLength};t.push(r),i(r)})})));for(let t=0;t!=n.length;t++){const s=n[t];0===s.point&&s.rep===i.id&&this.appendBuffer(this.buffer,s).then(t=>{this.buffer=t,e()}).catch(()=>{e()})}this.hooks.run("onBufferEnd"),e(t)})}fetchSegment_(t=""){let e,i=0,s=(new Date).getTime();return new Promise((n,r)=>{const o=this.rep().id,u=this.mpd.type,h=new XMLHttpRequest,l=this.segmentLength();h.onload=function(){if(h.status>=400&&u===d.kMPDType.dynamic)n(null);else if(h.status>=200&&h.status<400){const t=h.response;i+=t.byteLength;const r=((e=(new Date).getTime())-s)/1e3;r>l&&(0,a.clearBpsHistory)(),(0,a.pushBpsHistory)((0,a.bps)(i,r)),n(t)}else r(`Unable to fetch segment at "${t}" for rep "${o}"`)},h.open("GET",t),h.responseType="arraybuffer",h.send()})}appendBuffer(t,e){return new Promise((i,s)=>{this.rep(),n.default.ndef(t)&&s("Buffer invalid!"),n.default.ndef(e)&&s("Segment invalid!");const r=()=>{try{t.appendBuffer(new Uint8Array(e.data))}catch(t){}};t.updating?t.onupdateend=(()=>{r(),t.onupdateend=(()=>i(t))}):(r(),t.onupdateend=(()=>i(t)))})}bufferedLength(){const t=this.cache.length;return t<2?0:Math.round((t-1)*this.segmentLength())}fillBuffer(t){return new Promise(async e=>{const i=this.rep(),s=i.mediaURL(t);let r;try{r=await this.fetchSegment_(s)}catch(t){}if(n.default.ndef(r))return void e(null);if(this.type===d.kStreamType.image)return this.cache.push({point:t,mime:i.mimeType,data:(0,u.arrayBufferToBase64)(r),info:i.tileInfo}),void e(r.byteLength);this.cache.push({type:d.kSegmentType.segment,point:t,data:r,size:r.byteLength});const a=this.cache.length-1;try{this.buffer=await this.appendBuffer(this.buffer,this.cache[a])}catch(t){e(null)}e(r.byteLength)})}inCache(t=[]){let e=[],i=t=>{let e,i=0,s=this.cache.length-1,n=this.cache.length-1;if(this.cache.length>0&&this.cache[n].point===t)return n;for(;i<=s;)if((e=this.cache[n=(i+s)/2|0]).point<t)i=n+1;else{if(!(e.point>t))return n;s=n-1}return-1};for(let s=0;s!=t.length;s++){const n=t[s];i(n)>-1&&e.push(n)}if(t.constructor===Array)for(let s=0;s!=t.length;s++){const n=t[s];i(n)>-1&&e.push(n)}else{if(!(0,o.isInt)(t))throw`Invalid argument value : "${t}"`;{const s=t;i(s)>-1&&e.push(s)}}return e}makePoints(t,e,i){const s=this.rep();let n,r=this.lastPoint||0;var a=function(t){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t){var e=[],i=!0,s=!1,n=void 0;try{for(var r,a=t[Symbol.iterator]();!(i=(r=a.next()).done)&&(e.push(r.value),2!==e.length);i=!0);}catch(t){s=!0,n=t}finally{try{!i&&a.return&&a.return()}finally{if(s)throw n}}return e}(t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}(s.makePoints(this.mpd,t,e,i,r));return n=a[0],this.lastPoint=r=a[1],n}popCache(t=1){return new Promise((e,i)=>{let s=0;this.cache.length<t+1&&e();for(let t=1;t<this.cache.length;t++)if(this.cache[t].type!==d.kSegmentType.init&&this.cache[t-1].type===d.kSegmentType.init&&this.cache[t].type===d.kSegmentType.segment){s=t;break}0===s&&i(),s+1+t>this.cache.length&&i(),this.cache.splice(s,t),e()})}rep(){return this.mpd.repByID(this.id)}segmentLength(){const t=this.rep();if(n.default.ndef(t))throw`Unable to determine segment length of rep "${t.id}"`;return t.segmentLength()}switchToRep(t){return new Promise(e=>{for(let i=0;i!=this.cache.length;i++){const s=this.cache[i];0===s.point&&s.rep===t&&this.appendBuffer(this.buffer,s).then(i=>{this.buffer=i;for(let e=0;e!=this.sources.length;e++){const i=this.sources[e];if(i.id===t){this.id=i.id;break}}e()}).catch(()=>{e()})}})}updateMPD(){this.mpdWasUpdated=!0}}},function(t,e,i){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s,n=(s=i(0))&&s.__esModule?s:{default:s},r=i(7),a=i(3),o=i(1);e.default=class{constructor(t,e,i,s,u){let d,h,l,c,f,p,m,y,g,T,v,w,b,P,S,_,M,k;this.presentationTime=u,d=n.default.a("id",e),S=n.default.a("mimeType",t),n.default.ndef(S)&&(S=n.default.a("mimeType",e)),h=n.default.a("codecs",e);const D=n.default.a("width",e),I=n.default.a("height",e);l=(0,a.toInt)(D)||0,c=(0,a.toInt)(I)||0;const E=n.default.a("bandwidth",e);f=(0,a.toInt)(E),p=s||"";const L=i.split("/"),B=L.length;if(p=B>1?L.slice(0,B-1).join("/"):"/",p+="/"===p.charAt(p.length-1)?"":"/",(T=n.default.q("SegmentTemplate",e)[0])||(T=n.default.q("SegmentTemplate",t)[0]),T){y=n.default.a("media",T),m=n.default.a("initialization",T),n.default.def(m)&&(m=m.replace("$RepresentationID$",d));const t=n.default.a("startNumber",T);b=(0,a.toInt)(t);const e=n.default.a("timescale",T);P=(0,a.toInt)(e);const i=n.default.a("duration",T);_=(0,a.toInt)(i)}if(g=n.default.q("SegmentTimeline",t)[0],n.default.def(g)){let t=[];if(r.os.is("edge")){const e=g.childNodes;for(let i=0;i!=e.length;i++){const s=e[i];"s"===s.nodeName.toLowerCase()&&t.push(s)}}else t=g.children;w=t,v=this.timeline_(t,b)}if(S&&S.includes("video")&&l&&c?M=o.kStreamType.video:S&&S.includes("audio")&&f?M=o.kStreamType.audio:S&&S.includes("image")&&(M=o.kStreamType.image),M===o.kStreamType.image){let t="1x1";const i=n.default.a("duration",T),s=n.default.q("EssentialProperty",e)[0];s&&(t=n.default.a("value",s)),k={duration:1e3*parseInt(i),count:parseInt(t.split("x")[0]),width:l,height:c}}this.id=d,this.mimeType=S,this.codecs=h,this.width=l,this.height=c,this.bandwidth=f,this.baseURL=p,this.timelineParts=w,this.timeline=v,this.mediaTemplate=y,this.initialization=m,this.startNumber=b&&void 0!==b?b:null,this.timescale=P,this.segmentDuration=_,this.tileInfo=k,this.type=M}initURL(){const t=this.initialization,e=this.baseURL;return(e?`${e}${t}`:t).replace(/\$RepresentationID\$/g,`${this.id}`)}makePoints(t,e,i,s,r=0){return n.default.def(this.timeline)?this.makeTimelinePoints(r):[this.makeTemplatePoints(t,e,i,s),null]}makeTimelinePoints(t){let e,i=0,s=t,n=[];for(;s<=t;)s=this.timeline[i++];if(this.timeline.length>=5+(i-=1))e=i+5;else{const s=this.timeline.length-i;if(s<=0)return[[],t];e=i+s-1}for(;i<e;)n.push(this.timeline[i]),i++;if((n=n.filter((t,e,i)=>i.indexOf(t)===e)).length<1)return[[],t];for(let e=0;e!=n.length;e++)if(t>=n[e])throw"last >= data";return this.startNumber?[n,n[n.length-1]]:[n,n[n.length-1]+this.segmentLength()]}makeTemplatePoints(t,e,i,s){const n=this.segmentLength();if(t.type===o.kMPDType.static){if(this.type===o.kStreamType.image&&null!==this.tileInfo){const e=Math.ceil(t.duration/this.tileInfo.duration);return new Array(e).fill(0).map((t,e)=>e+1)}const s=parseInt(Math.ceil(parseFloat((i<e?e+1e3:i)-e)/parseFloat(n))),r=parseInt(Math.ceil(parseFloat(e)/parseFloat(n)));return new Array(s).fill(r).map((t,e)=>t+(e+1))}if(t.type===o.kMPDType.dynamic){const e=Math.abs(s-t.startTime);return i&&i>s?Array(1+(i-s)/n).fill().map((t,i)=>(e+n*i)/n-10):[Math.ceil(e/n-10)]}throw`Unable to decipher source type ("${t.type}")`}mediaURL(t){const e=/\$Time\$/g,i=/\$Number\$/g,s=`${t}`;let n=this.mediaTemplate.replace(/\$RepresentationID\$/g,`${this.id}`);if(e.test(n)&&this.timeline.length>0)n=n.replace(e,s);else if(/(\$Number%(\d+)d\$)/g.test(n)){const t=/(\$Number%(\d+)d\$)/g.exec(n),e=parseInt(t[t.length-1])+1,r=s.padStart(e-1,"0");n=(n=n.replace(t[0],r)).replace(i,s)}else n=n.replace(i,s);const r=this.baseURL;return r?`${r}${n}`:n}segmentLength(){if(this.timelineParts&&this.timelineParts.length>0){const t=[];for(let e=0;e<this.timelineParts.length;e++){const i=this.timescale,s=parseInt(this.timelineParts[e].getAttribute("d"));t.push(s/i)}if(t.length>0)return t.reduce((t,e)=>t+e)/t.length*1e3}const t=parseFloat(this.timescale),e=parseFloat(this.segmentDuration);if(n.default.ndef(t)||isNaN(t))return 1e3*e;const i=Math.floor(e/t);return 1e3*parseInt(i)}weight(){return this.width+this.height+this.bandwidth}timeline_(t,e){let i=[];if(e)for(let t=0;t<5;t++)i.push(e+t);else{let e=0;for(let s=0;s!=t.length;s++){const r=t[s];let a=parseInt(n.default.a("t",r)),o=parseInt(n.default.a("d",r)),u=parseInt(n.default.a("r",r));a-=this.presentationTime,u=isNaN(u)||u<1?1:u;let d=n.default.def(a)&&!isNaN(a)?a:e;for(let t=0;t!=u;t++){let s=d+o*(t+1);i.push(s),e=s}}}return i}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0});var n=s(i(0)),r=s(i(10)),a=i(3);e.default=class{constructor(t,e,i,s,r){const o=n.default.a("maxWidth",t),u=n.default.a("maxHeight",t);this.adp=t,this.index=e,this.maxWidth=(0,a.toInt)(o),this.maxHeight=(0,a.toInt)(u),this.reps=this.reps_(t,i,s,r)}reps_(t,e,i,s){const a=n.default.q("Representation",t);if(a&&a.length>0){let o=[];for(let n=0;n!=a.length;n++)o.push(new r.default(t,a[n],e,i,s));const u=o.map(t=>n.default.ndef(t.bandwidth)?null:t.bandwidth);if(u.includes(null)){const t=u.findIndex(t=>null!==t),e=t>-1?u[t]:0;o=o.map(t=>(t.bandwidth=e,t))}return o.sort((t,e)=>t.weight()<e.weight()?-1:t.weight()>e.weight()?1:0),o}throw`No representations present in adaptation[${this.index}]`}bestRep(t){return n.default.def(t)?this.matchBandwidth(t):this.reps[this.reps.length-1]}matchBandwidth(t){const e=t,i=this.reps.map(t=>t.bandwidth).reduce((t,i)=>Math.abs(i-e)<Math.abs(t-e)?i:t);return this.reps.find(t=>t.bandwidth===i)}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.MPD=void 0;var n=s(i(0)),r=s(i(11)),a=s(i(6)),o=i(4),u=i(1),d=i(2),h=i(3);e.MPD=class{constructor(t={}){this.config=(0,d.mergeDicts)(t,{url:"",base:"",data:null}),this.fetchedOnce=!1}async setup(){let t,e=0,i=(new Date).getTime();const s=await this.fetch_(this.config.url,this.config.data);e+=s.length,t=(new Date).getTime(),(0,o.pushBpsHistory)((0,o.bps)(e,(t-i)/1e3));const n=this.parse_(s);if(n)throw n;return Promise.resolve(this)}fetch_(t="",e){return new Promise(i=>{n.default.def(e)&&i(e,"data");const s=new XMLHttpRequest;s.onload=(()=>{const t=s.response;if(this.fetchedOnce||(this.fetchedOnce=!0),n.default.def(t)&&t.includes(`${u.kMPDType.dynamic}`)){const t=s.getResponseHeader("Date"),e=new Date(t);a.default.sync(e)}i(t,"xml")}),s.open("GET",t),s.send()})}parse_(t){const e=this.config.url,i=this.config.base;return this.mpd=this.xml_(t),this.baseURL=this.baseURL_(this.mpd,i),this.startTime=this.startTime_(this.mpd),this.adps=this.adps_(this.mpd,e,this.baseURL,this.startTime),this.duration=this.duration_(this.mpd),this.dvr=this.dvr_(this.mpd),this.muxed=this.muxed_(this.mpd),this.type=this.type_(this.mpd),this.updatePeriod=this.updatePeriod_(this.mpd),this.adps<0?"Bad adps":this.type==u.kMPDType.static&&-1==this.duration?"Bad duration":this.type<0?"Bad type":this.type==u.kMPDType.dynamic&&(-1==this.startTime||isNaN(this.startTime)||n.default.ndef(this.startTime))?"Bad start":this.type==u.kMPDType.dynamic&&this.updatePeriod<0?"Bad update":null}adps_(t,e,i,s){const a=n.default.q("Period",t)[0],o=n.default.q("AdaptationSet",a);if(!o||o.length<1)return-1;const u=[];for(let t=0;t!=o.length;t++)u.push(new r.default(o[t],t,e,i,s));return u}baseURL_(t,e){let i="";return e&&(i=`${e}`),i.length<1&&(i=(i=n.default.q("MPD BaseURL",t)[0])&&i.textContent?i.textContent.trim():"/"),i+("/"!==i.charAt(i.length-1)?"/":"")}duration_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("mediaPresentationDuration",e);return n.default.ndef(i)||!i.hasOwnProperty("length")||i.length<1?-1:(0,h.toDuration)(i)}dvr_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("timeShiftBufferDepth",e);return n.default.ndef(i)||!i.hasOwnProperty("length")||i.length<1?-1:(0,h.toDuration)(i)}muxed_(t){const e=n.default.q("Representation",t)[0];if(!e)return-1;const i=n.default.a("codecs",e);return i.includes("avc")&&i.includes("mp4")}type_(t){const e=n.default.q("MPD",t)[0];let i=n.default.a("type",e);return i&&""!==i.trim()?i.trim():-1}startTime_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("availabilityStartTime",e);return n.default.ndef(i)?-1:a.default.parse(i)}updatePeriod_(t){const e=n.default.q("MPD",t)[0],i=n.default.a("minimumUpdatePeriod",e);if(n.default.ndef(i))return-1;const s=(0,h.toDuration)(i);return s<1e3?1e3:s}xml_(t){return t.querySelectorAll?t:(new DOMParser).parseFromString(t,"text/xml",0)}repByID(t){for(let e=0;e<this.adps.length;e++){const i=this.adps[e];for(let e=0;e<i.reps.length;e++){const s=i.reps[e];if(s.id===t)return s}}throw`Unable to find rep with ID '${t}'`}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.State=void 0;var n=s(i(0)),r=s(i(6)),a=s(i(5)),o=i(12),u=i(9),d=i(2),h=i(1),l=i(4),c=i(8);e.State=class{constructor(t={},e=new a.default){this.config=(0,d.mergeDicts)(t,{playlist:[],base:0,lead:0,start:0,timed:0,track:0,query:""}),this.config.query+=this.config.query.match(/(^|\s)video(\s|\.|$)/)?"":" video",this.hooks=e}setup(){return new Promise(async(t,e)=>{const i=n.default.q(this.config.query)[0];n.default.ndef(i)&&e("No injection point"),i.onerror=(()=>{}),i.addEventListener("encrypted",()=>{const t=n.default.q(this.config.query)[0].mediaKeys;if((null===t||void 0===t)&&window.navigator.requestMediaKeySystemAccess){const t="com.widevine.alpha",e=[{initDataTypes:["cenc"],audioCapabilities:[{contentType:'audio/mp4;codecs="mp4a.40.2"',robustness:"SW_SECURE_CRYPTO"}],videoCapabilities:[{contentType:'video/mp4;codecs="avc1.42E01E"',robustness:"SW_SECURE_CRYPTO"}]}];try{navigator.requestMediaKeySystemAccess(t,e).then(()=>{}).catch(()=>{})}catch(t){}}}),this.video=i,this.paused=!0,this.loading=!1,this.started=!1,this.qualityAuto=!0,this.qualityQueued=null,this.bufferTime=this.config.start,this.config.timed>0?t():(this.mpdUpdateInterval&&clearInterval(this.mpdUpdateInterval),await this.init_(),this.hooks.run("onReady"),t())})}init_(){return n.default.def(this.mpd)?Promise.resolve():new Promise(async t=>{const e=this.config.track;this.mpd=new o.MPD({url:this.config.playlist[e].dash.url,base:this.config.playlist[e].dash.base}),this.mpd=await this.mpd.setup(),this.mediaSource=await this.mediaSource_(),this.usingHLS()?t():(this.streams=this.usingHLS()?null:await this.buildStreams_(this.mpd,this.mediaSource),this.mpd.type===h.kMPDType.dynamic&&(this.mpdUpdateInterval=setInterval(async()=>{this.mpd=await this.mpd.setup()},this.mpd.updatePeriod)),t())})}buildStreams_(t,e){return new Promise(i=>{let s=0,n=[];for(let r=0;r<t.adps.length;r++){const a=t.adps[r],o=a.bestRep(4*(0,l.bpsAvg)()),d=new u.Stream({adp:a,id:o.id,mediaSource:e,mpd:t,sources:t.adps[r].reps},this.hooks);d.setup().then(()=>{n.push(d),++s===t.adps.length&&i(n)})}})}mediaSource_(){return new Promise((t,e)=>{if(this.usingHLS()){const e=this.config.playlist[this.config.track].hls;if(e.url&&e.url.length&&e.url.length>0)this.video.type=c.hlsMimeType,this.video.src=e.url,t(null);else{const e=(0,c.mpdToM3U8)(this),i=`data:${c.hlsMimeType};base64,${btoa(e)}`;this.video.type=c.hlsMimeType,this.video.src=i,t(null)}}else{const i=new MediaSource;i.addEventListener("sourceopen",()=>{"open"===i.readyState?t(i):e("MediaSource failed")}),this.video.src=this.url_(i)}})}url_(t){if(n.default.def(t))return URL.createObjectURL(t);throw"MediaSource failed"}adjustQuality(t=0,e=1){return this.loading?Promise.resolve(!1):new Promise(async i=>{if(this.qualityAuto||null===this.qualityQueued)if(this.qualityAuto){if(null===this.streams||void 0===this.streams)return void i(!1);for(let s=0;s<this.streams.length;s++){const n=this.streams[s],r=n.adp;let a;if(e>=.5){const t=this.mpd.repByID(n.id);a=r.matchBandwidth(.8*t.bandwidth)}else a=r.matchBandwidth(t);n.id!==a.id?n.switchToRep(a.id).then(()=>{s===this.streams.length-1&&(this.loading=!1,this.hooks.run("onAdapt",this.currentBitrate()),i(!0))}):(this.loading=!1,i(!1))}}else this.loading=!1,i(!1);else{const t=this.videoStream(),e=this.qualityQueued.rep.id;this.qualityQueued=null,await t.switchToRep(e),this.loading=!1,this.hooks.run("onAdapt",this.currentBitrate()),i(!0)}})}audioStream(){if(n.default.ndef(this.streams))return null;for(let t=0;t!=this.streams.length;t++){const e=this.streams[t];if(e.type===h.kStreamType.audio||e.type===h.kStreamType.muxed)return e.rep}return null}codecs(){return this.streams.map(t=>t.codecs())}currentBitrate(){const t=this.videoRep();return n.default.ndef(t)?0:t.bandwidth/1e3}currentResolution(){const t=this.videoRep();return n.default.ndef(t)?"uninitialized":`${t.width}x${t.height}`}fillBuffers(t=null){const e=this.mpd.type===h.kMPDType.dynamic;if(this.loading)return Promise.resolve([-1,-1,-1]);if(this.started&&this.paused)return Promise.resolve([-1,-1,-1]);const i=r.default.now(),s=this.segmentLengths();if(s<0)return Promise.resolve([-1,-1,-1]);const a=s.reduce((t,e)=>Math.min(t,e))/2,o=this.streams.map(t=>t.rep().startNumber);return e&&o.includes(null)&&this.lastTime&&i-this.lastTime<a?Promise.resolve([-1,-1,-1]):new Promise(s=>{const a=this.bufferTime,u=t||(this.started?this.config.lead:this.config.base),d=Math.min(this.mpd.duration,a+u),h=d<0?0:d;let c,f=0,p=r.default.init().getTime();return(!e||e&&o.includes(null))&&(this.loading=!0),this.streams.reduce((t,o,d)=>t.then(()=>{let t=o.makePoints(a,e?null:h,i,o.id);t=t.filter(t=>n.default.def(t));let m=o.inCache(t);return(t=t.filter(t=>!m.includes(t))).length>0?this.hooks.run("onBufferStart"):(this.loading=!1,s([-1,-1,-1])),t.reduce((e,a,m)=>e.then(()=>o.fillBuffer(a).then(e=>{if(n.default.ndef(e))s([-1,-1,-1]);else if(f+=e,d===this.streams.length-1&&m===t.length-1){this.hooks.run("onBufferEnd");const t=((c=r.default.init().getTime())-p)/1e3;t>u&&(0,l.clearBpsHistory)(),(0,l.pushBpsHistory)((0,l.bps)(f,t));const e=(0,l.kbpsAvg)(),n=(0,l.speedFactor)(e,f,c-p);this.bufferTime=h,this.started=!0,this.loading=!1,this.lastTime=r.default.now(),s([(0,l.bpsAvg)(),n,i])}})),Promise.resolve())}),Promise.resolve())})}imageStream(){if(n.default.ndef(this.streams))return null;for(let t=0;t!=this.streams.length;t++){const e=this.streams[t];if(e.type===h.kStreamType.image)return e.rep}return null}pause(){return this.paused=!0,this.hooks.run("onPause"),this.video.pause()}play(){return this.paused=!1,this.hooks.run("onPlay"),this.video.play()}queueQuality(t){const e=t.repID;if("auto"===t.name.toLowerCase())return this.qualityAuto=!0,void(this.qualityQueued=null);for(let t=0;t!=this.streams.length;t++){const i=this.streams[t];for(let t=0;t!=i.sources.length;t++)if(i.sources[t].id===e)return this.qualityAuto=!1,void(this.qualityQueued={stream:i,repID:e})}}segmentLengths(){return null===this.streams||void 0===this.streams?-1:this.streams.map(t=>t.segmentLength())}usingHLS(){if(!(0,c.hlsPreferred)())return!1;const t=this.config.playlist[this.config.track].hls;return!(!n.default.def(t)||!t.url&&!t.gen)}qualities(){let t=[];if(n.default.ndef(this.mpd)||n.default.ndef(this.mpd.adps))return t;const e=this.videoRep();if(n.default.ndef(e))return t;for(let i=0;i!=this.mpd.adps.length;i++){const s=this.mpd.adps[i];if(n.default.ndef(s.reps)||s.reps.length<1)continue;const r=s.reps[0];if(r.type===h.kStreamType.video||r.type===h.kStreamType.muxed)for(let i=0;i!=s.reps.length;i++){const n=s.reps[i];t.push({rep:n,current:e.id==n.id})}}return t}videoRep(){const t=this.videoStream();return t?t.rep():null}videoStream(){let t=null;if(n.default.ndef(this.streams))return t;for(let e=0;e!=this.streams.length;e++){const i=this.streams[e],s=i.rep();if(s.type===h.kStreamType.video||s.type===h.kStreamType.muxed){t=i;break}}return t}}},function(t,e,i){"use strict";function s(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(e,"__esModule",{value:!0}),e.Player=void 0;var n=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var i=[],s=!0,n=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(s=(a=o.next()).done)&&(i.push(a.value),!e||i.length!==e);s=!0);}catch(t){n=!0,r=t}finally{try{!s&&o.return&&o.return()}finally{if(n)throw r}}return i}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},r=s(i(0)),a=s(i(5)),o=i(7),u=i(13),d=i(2),h=i(1);class l{constructor(t={}){const e={playlist:[],hooks:{},drm:{playready:{url:"",data:""},widevine:{url:"",data:""}},auto:!0,adapt:!0,base:o.os.is("edge")?5e3:1e3,debug:!1,lead:5e3,loop:!1,query:".pepper",start:0,timed:0,track:0,ui:!0};this.config=(0,d.mergeDicts)(t,e),this.lazyStart=!1,this.initialized=!1,this.config.playlist.length>0&&this.setup_()}async setup_(){if(this.initialized=!0,this.hooks=new a.default(this.config.hooks),!this.config.query.length||this.config.query.length<1)throw"Invalid insertion query";this.config.base<100&&(this.config.base=100),this.config.lead<1e3&&(this.config.lead=1e3),this.renderUI(),this.state=new u.State(this.config,this.hooks),await this.state.setup();const t=this.state.config.timed;t>0?this.startsInMs=t:this.init_()}async init_(){if(await this.state.init_(),!this.state.usingHLS()){var t=await this.state.fillBuffers(),e=n(t,3);const i=e[0],s=e[1],r=this.state.mpd.type;r===h.kMPDType.dynamic&&(this.safariStartTime=e[2]/1e3),await this.state.adjustQuality(i,s),this.config.auto&&(r===h.kMPDType.dynamic&&o.os.is("safari")&&(this.state.video.currentTime=this.safariStartTime),this.lazyStart&&!this.browserBlocked||(this.browserBlocked=!1,this.play()))}return Promise.resolve()}bufferTime(){return this.state.bufferTime}currentBitrate(){return this.state.currentBitrate()}currentResolution(){return this.state.currentResolution()}currentTime(){return r.default.ndef(this.state)||r.default.ndef(this.state.video)?0:this.forcedCurrentTime?this.forcedCurrentTime+1e3*this.state.video.currentTime:1e3*this.state.video.currentTime}didEnd(){return 1e3*Math.round(this.currentTime()/1e3)>=this.duration()-2e3}duration(){return this.state.mpd.duration}isPaused(){return!!r.default.ndef(this.state)||this.state.paused}pause(){return this.state.pause()}async play(){this.recoverBlock_(),this.initialized||(this.lazyStart=!0,await this.setup_());const t=this.state.mpd.type;try{await this.state.play()}catch(t){this.hooks.run("onError","browser blocked player start"),this.browserBlocked=!0,await this.state.pause()}if(t===h.kMPDType.static)this.state.video.ontimeupdate=(async()=>{if(this.recoverBlock_(),this.currentTime()>=this.bufferTime()-this.config.lead/2){var t=await this.state.fillBuffers(),e=n(t,2);this.state.adjustQuality(e[0],e[1])}return this.didEnd()&&(this.hooks.run("onEnd"),this.state.video.currentTime=0,this.config.loop||this.pause()),Promise.resolve()});else if(t===h.kMPDType.dynamic){const t=this.state.segmentLengths(),e=t.reduce((t,e)=>Math.min(t,e))/2,i=t.reduce((t,e)=>Math.max(t,e));setInterval(async()=>{this.recoverBlock_();var t=await this.state.fillBuffers(i),e=n(t,2);const s=e[0],r=e[1];if(this.lastSpeed=s,this.config.auto&&!this.isPaused())try{await this.state.play()}catch(t){this.hooks.run("onError","browser blocked player start"),this.browserBlocked=!0,await this.state.pause()}return s>=0&&r>=0&&await this.state.adjustQuality(s,r),Promise.resolve()},this.lastSpeed?i-e*this.lastSpeed:e)}}renderUI(){if(!this.injectedUI){const t=r.default.q(this.config.query)[0];if(!r.default.q("video",t)[0]){const e=this.state&&this.state.usingHLS(),i=document.createElement("video");i.controls=!1,i.autoplay=this.config.auto&&!e,i.addEventListener("click",()=>{this.state.video.play().catch(()=>void 0)}),i.addEventListener("contextmenu",t=>t.preventDefault()),t.appendChild(i)}this.injectedUI=!0}}async seek(t){if(r.default.ndef(t))return;const e=this.state.mpd.duration*(t/100);this.config.start=e,this.forcedCurrentTime=e,this.state.bufferTime=e,this.lazyStart&&(this.initialized=!1,this.lazyStart=!1),this.state=new u.State(this.config,this.hooks),await this.state.setup(),this.init_()}qualities(){return r.default.ndef(this.state)?[]:this.state.qualities()}queueQuality(t=null){r.default.ndef(this.state)||(this.state.qualityAuto=!1,this.state.qualityQueued=t)}volume(t=-1){return r.default.ndef(this.state)||r.default.ndef(this.state.video)?-1:(t>-1&&t<=1&&(this.state.video.volume=t),this.state.video.volume)}async recoverBlock_(){return!!this.browserBlocked&&(this.state=new u.State(this.config,this.hooks),await this.state.setup(),this.init_(),!0)}}e.default=l,e.Player=l}])});